# Практическая работа №14 'Регистрация и авторизация на бэкенде'

---

## Оглавление

1. Описание
2. Функциональность
3. Ссылка на GitHub Pages

---

## 1. Описание

Данный проект - это бэкэнд одностраничного сайта, представляющий собой страничку на сервере с функциональностью и функциями, описанными ниже. Проект написан на js.

---

## 2. Функциональность

Данный проект реализуется на базе следующих функций:

- Инфраструктура проекта;
- База данных, контроллеры и роуты для карточек и пользователей;
- Обработка ошибок;

### 2.1 Инфраструктура проекта

Инфраструктура проекта представляется собой с папками, файлами и основным файлом app.js, а также имеет настроеные

- editorconfig(помогает поддерживать согласованные стили кодирования для нескольких разработчиков, работающих над одним проектом в различных редакторах и IDE),
- линтер(отлавливает ошибки и следит за единообразием кода),
- файлом .gitignore(служит для указания в нём файлов и папок, которые необходимо скрыть от системы контроля версий git) и т.д.

### 2.2 База данных, контроллеры и роуты для карточек и пользователей

В проекте используется mestodb. В нее записываются карточки и пользователи посредством создания моделей на основе созданных схем. Схема пользователя представляет собой объект из трех составляющих, составленных по типу 'ключ - значение'(name, about, avatar). Схема карточки состоит из 5 составляющих по тому же типу(name, link, owner, likes, createdAt).

Роуты обязательно подключаются в файле app.js, а записываются в папку router, в них используется информация о методах, ссылках запросов и контроллеры, которые записываются в отдельной одноименной папке.

Роуты и контроллеры пользователя могут следующее:

- возвращать всех пользователей,
- возвращать пользователя по id,
- возвращать текущего пользователя,
- обновлять профиль или аватар;
- аутифицировать пользователя,
- зарегистрировать(создать) пользователя.

Роуты и контроллеры карточек могут следующее:

- возвращать все карточки,
- создать карточку,
- удалить карточку по id;
- поставить/убрать лайк.

### 2.3 Обработка ошибок

В случаях, если при запросе что-то пошло не так — вернутся соответствующие коды ошибок:
400 — переданы некорректные данные в методы создания карточки, пользователя, обновления аватара пользователя или профиля;
401 - Отсутствие токена (JWT), некорректный токен (JWT), невалидный пароль;
403 - Обновление чужого профиля, чужого аватара, удаление чужой карточки;
404 — карточка или пользователь не найден;
409 - Попытка зарегистрировать вторую учетную запись на тот же email;
500 — На сервере произошла ошибка.

### 2.4 Безопасность

Безопасность данного сайта представляет собой следующие составляющие:

2.4.1. Защита Авторизацией.
Данная технология реализована засчет создания мидлвэра для авторизации, задача которого верифицировать токен и если с ним все в порядке, то добавлять пейлоуд токена в объект запроса.

```
req.user = payload;
next();
```

2.4.2. Пароли хэшируются и не возвращаются пользователю в ответе запроса.
Хэширование пароля реализовано за счет метода _bcrypt.hash_. Отсутствие пароля при возврате пользователей в ответе запроса реализовано за счет поля _select: false_ в графе pasword в схеме пользователя.

2.4.3. Безопасный способ хранения JWT в браузере
Данные в браузере сохраняются в так называемые куки. Это фрагменты данных, относящихся к определённому домену.
Такую куку нельзя прочесть из JavaScript. Токен защищен.

```
// отправим токен, браузер сохранит его в куках
res
  .cookie('jwt', token, {
        // token - наш JWT токен, который мы отправляем
    maxAge: 3600000,
    httpOnly: true
  })
  .end(); // если у ответа нет тела, можно использовать метод end
```

2.4.4. Реализована централизованная обработка ошибок
Такой способ приводит к тому, что ошибки не дублируются, а в случае отсутствия статуса и сообщения об ошибке, отправляется ошибка со статусом 500 и сообщением "На сервере произошла ошибка".

```
const getUsers = (req, res, next) => {
  // остальной код
    .catch((err) => {
      next(err);
    });
};

module.exports = (error, req, res, next) => {
  const { statusCode = 500, message } = error;
  res.status(statusCode).send({
    message: statusCode === 500 ? "На сервере произошла ошибка." : message,
  });
  next();
};

```

2.4.5. Настройка заголовков ответа
Заголовки безопасности можно проставлять автоматически — для этого есть модуль Helmet:

```
const helmet = require('helmet');
app.use(helmet());
```

2.4.6. Защита от брутфорсу и DDоSу
Чтобы защититься от множества автоматических запросов, существует специальный мидлвэр — express-rate-limit:

```
const express = require('express');
const rateLimit = require('express-rate-limit');

const app = express();

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // за 15 минут
  max: 100 // можно совершить максимум 100 запросов с одного IP
});

// подключаем rate-limiter
app.use(limiter);
```

### 2.5 Валидация

Валидация данного сайта представляет собой следующие составляющие:

2.5.1. Валидация приходящих на сервер запросов;
Тела запросов к серверу валидируются до передачи обработки в контроллеры. Если запрос принимает какую-то информацию в заголовках или параметрах, она валидируется.
API возвращает ошибку, если запрос не соответствует схеме.

2.5.2. Валидация данных на уровне схемы
Валидация данных на уровне схемы просиходит следующим образом:

```
const userSchema = new mongoose.Schema(
  {
    ...
    // информация о пользователе
    about: {
      type: String,
      minlength: [2, "Описание не должно быть короче 2-х символов"],
      maxlength: [30, "Описание не должно быть длиннее 30-и символов"],
      default: "Исследователь",
    },
    // ссылка на аватарку
    avatar: {
      type: String,
      default:
        "https://pictures.s3.yandex.net/resources/jacques-cousteau_1604399756.png",
      validate: {
        validator: (avatar) => {
          /https?:\/\/(www\.)?[a-zA-Z0-9-@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([a-zA-Z0-9()-@:%_+.~#?&//=]*)/.test(
            avatar
          );
        },
        message: "Передан некорректный электронный адрес",
      },
    },
   ...}
);
```

---

## 3. Ссылка на GitHub

https://github.com/milenairon/express-mesto-gha
